#!/bin/bash

CLI="$HOME/dev/bitcoin-abc/build/src/bitcoin-cli -testnet "
CLITX="$HOME/dev/bitcoin-abc/build/src/bitcoin-tx -testnet "

# 200 bytes op_return
#SCRIPT="OP_RETURN \
#0x0102030405060708090001020304050607080900010203040506070809000102030405060708090001020304050607080900\
#0102030405060708090001020304050607080900010203040506070809000102030405060708090001020304050607080900\
#0102030405060708090001020304050607080900010203040506070809000102030405060708090001020304050607080900\
#0102030405060708090001020304050607080900010203040506070809000102030405060708090001020304050607080900"

#SCRIPT='0 BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM BIN2NUM 0 EQUAL'
SCRIPT='1 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR 1 XOR'
#SCRIPT='
#SCRIPT='1'
FEE=0.0001
COUNT=1
OUTPUTSPERTX=1

## use this to overwrite utxos
##UNSPENT='42ac54530df025b9d5b4687fdef4555878748e0d0be2509f16e1833159f547f5:13'


ECHO="echo "
ADDR=`$CLI getnewaddress|cut -d ":" -f 2`

source ./util.sh

$ECHO "TEST CASE DESCRIPTON (TESTNET)"
$ECHO "  Script:$SCRIPT "
$ECHO "  (nr opcodes):`echo $SCRIPT | wc -w`"
$ECHO "  NR OF TXs: $COUNT"
$ECHO "  NR OF OUTPUTS PER TXs: $OUTPUTSPERTX"

#TXIDS='42ac54530df025b9d5b4687fdef4555878748e0d0be2509f16e1833159f547f5|12.9999'

function createSpendTxs () {
    $ECHO " == Creating Spend TXs"
    for TXIDVALUE in $TXIDS ; do
        TXID=`echo $TXIDVALUE| cut -d "|" -f 1`;
        V=`echo $TXIDVALUE| cut -d "|" -f 2`;
        VALUE=`echo $V \* $OUTPUTSPERTX- $FEE | bc -l`

        COUNTER=0
        TXCMD="$CLITX -create"
        while [  $COUNTER -lt $OUTPUTSPERTX ]; do
            TXCMD="$TXCMD  in=$TXID:$COUNTER "
          let COUNTER=COUNTER+1 
        done

        TXCMD="$TXCMD outaddr=$VALUE:$ADDR"

        TX1=`eval $TXCMD`
        if [ -z "$TX1" ] ; then
            echo "!! Could not create tx with $TXCMD"
            exit 1
        fi


        STXS="$STXS $TX1"
    done
}

if [ -z "$UNSPENT" ]
then
    getUnspent 
fi
createTxs 
time sendTxs && \
createSpendTxs && \
time sendSpendTxs && \
$ECHO "  After everything is confirmed, funds should be back at $ADDR"




